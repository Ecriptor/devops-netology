# Домашнее задание к занятию "10.01. Зачем и что нужно мониторить"

## Обязательные задания

1. Вас пригласили настроить мониторинг на проект. На онбординге вам рассказали, что проект представляет из себя
   платформу для вычислений с выдачей текстовых отчетов, которые сохраняются на диск. Взаимодействие с платформой
   осуществляется по протоколу http. Также вам отметили, что вычисления загружают ЦПУ. Какой минимальный набор метрик вы
   выведите в мониторинг и почему?
```aidl
Джентельменский набор
1. CPU LA -- средняя загрузка процессора (хотя он в себя еще зависит не только от процессора)
2. Нагрузка на дисковую систему IOPS, inods, место
3. RAM -- сколько памяти свободно
4. Сетевая доступность, коды и время ответа
```

2. Менеджер продукта посмотрев на ваши метрики сказал, что ему непонятно что такое RAM/inodes/CPUla. Также он сказал,
   что хочет понимать, насколько мы выполняем свои обязанности перед клиентами и какое качество обслуживания. Что вы
   можете ему предложить?
```aidl
SLO (Service Level Objective) — показатели совокупного успеха SLI в течение определенного периода времени
SLI (Service Level Indicator) = (сумма 200 и 300 ответов ) / (все ответы)
```

3. Вашей DevOps команде в этом году не выделили финансирование на построение системы сбора логов. Разработчики в свою
   очередь хотят видеть все ошибки, которые выдают их приложения. Какое решение вы можете предпринять в этой ситуации,
   чтобы разработчики получали ошибки приложения?
```aidl
1. Самое простое сделать отправку логов в syslog, там написать скрипт по выгрепыванию ошибок и отправку оповещений через postfix
2. Поднять на коленке zabbix и в нем настроить проверки и отправку
```

3. Вы, как опытный SRE, сделали мониторинг, куда вывели отображения выполнения SLA=99% по http кодам ответов.
   Вычисляете этот параметр по следующей формуле: summ_2xx_requests/summ_all_requests. Данный параметр не поднимается выше
   70%, но при этом в вашей системе нет кодов ответа 5xx и 4xx. Где у вас ошибка?
```aidl
Ошибка в формуле, не учтены редиректы 
Верная формула 
SLI = (summ_2xx_requests+summ_2xx_requests)/summ_all_requests

```

## Дополнительное задание (со звездочкой*) - необязательно к выполнению

Вы устроились на работу в стартап. На данный момент у вас нет возможности развернуть полноценную систему
мониторинга, и вы решили самостоятельно написать простой python3-скрипт для сбора основных метрик сервера. Вы, как
опытный системный-администратор, знаете, что системная информация сервера лежит в директории `/proc`.
Также, вы знаете, что в системе Linux есть  планировщик задач cron, который может запускать задачи по расписанию.

Суммировав все, вы спроектировали приложение, которое:
- является python3 скриптом
- собирает метрики из папки `/proc`
- складывает метрики в файл 'YY-MM-DD-awesome-monitoring.log' в директорию /var/log
  (YY - год, MM - месяц, DD - день)
- каждый сбор метрик складывается в виде json-строки, в виде:
  + timestamp (временная метка, int, unixtimestamp)
  + metric_1 (метрика 1)
  + metric_2 (метрика 2)

    ...

  + metric_N (метрика N)

- сбор метрик происходит каждую 1 минуту по cron-расписанию

Для успешного выполнения задания нужно привести:

а) работающий код python3-скрипта,

```python
#!/usr/bin/env python3
from datetime import datetime
import time
import json

log={}

#Unixtimestamp
timestamp = int(time.time())
log["timestamp"] = timestamp

#Load Average
with open("/proc/loadavg", "r") as la:
    log["cpu_loadavg"] = la.read()
#Uptime
with  open("/proc/uptime", "r") as uptime:
    log["uptime"] = uptime.read()
#MemINFO
with open("/proc/meminfo", "r") as mem:
    meminfo = mem.readlines()
    log["freemem"] = meminfo[1]
#Kernel Version
with open("/proc/version", "r") as kernel:
    kernel_ver = kernel.read().split()
    log["kernel_version"] = kernel_ver[2]
#SWAP
with open("/proc/swaps", "r") as swap:
    swaps = swap.readlines()
    log["swap"] = swaps[1]

#Формируем Лог в Файл
filename = date.today().strftime('%y-%m-%d-awesome-monitoring.log')
with open(filename, 'ab') as fp:
    fp.write(json.dumps(log).encode("utf-8"))
    fp.write(('\n').encode("utf-8")) #перенос строки
```

б) конфигурацию cron-расписания,
```bash
*/1 * * * * python3 /opt/script/proc_metrics.py  > /dev/null 2>&1
```

в) пример верно сформированного 'YY-MM-DD-awesome-monitoring.log', имеющий не менее 5 записей,
```bash
{"timestamp": 1617977642, "cpu_loadavg": "0.20 0.27 0.37 9/987 31446\n", "uptime": "603382.43 248673.45\n", "freemem": "MemFree:          449376 kB\n", "kernel_version": "3.10.0-1160.15.2.el7.x86_64", "swap": "/dev/dm-1partition\t4194300\t61544\t-2\n"}
{"timestamp": 1617977701, "cpu_loadavg": "0.11 0.23 0.35 5/992 32496\n", "uptime": "603441.62 248780.41\n", "freemem": "MemFree:          441364 kB\n", "kernel_version": "3.10.0-1160.15.2.el7.x86_64", "swap": "/dev/dm-1partition\t4194300\t61544\t-2\n"}
{"timestamp": 1617977761, "cpu_loadavg": "0.08 0.21 0.34 1/983 33663\n", "uptime": "603501.98 248889.17\n", "freemem": "MemFree:          440516 kB\n", "kernel_version": "3.10.0-1160.15.2.el7.x86_64", "swap": "/dev/dm-1partition\t4194300\t61544\t-2\n"}
{"timestamp": 1617977821, "cpu_loadavg": "0.24 0.23 0.33 1/986 34756\n", "uptime": "603562.09 248997.66\n", "freemem": "MemFree:          435260 kB\n", "kernel_version": "3.10.0-1160.15.2.el7.x86_64", "swap": "/dev/dm-1partition\t4194300\t61544\t-2\n"}
{"timestamp": 1617977881, "cpu_loadavg": "0.66 0.34 0.36 8/995 36039\n", "uptime": "603622.18 249105.04\n", "freemem": "MemFree:          427632 kB\n", "kernel_version": "3.10.0-1160.15.2.el7.x86_64", "swap": "/dev/dm-1partition\t4194300\t61544\t-2\n"}
```

P.S.: количество собираемых метрик должно быть не менее 4-х.
P.P.S.: по желанию можно себя не ограничивать только сбором метрик из `/proc`.
